name: Primitives
author: Rodolfo Herrera Hernandez
license: MIT
version: 1.0.0
homepage: https://github.com/rodyherrera/OpenDXA

# Per Frame Document Listing
listing:
    dislocation-analysis:
        aggregators:
            displayName: Dislocation Analysis
            count: true
        trajectory: Trajectory
        analysis.config.identificationMode: Identification Mode
        timestep: Timestep
        analysis.config.rmsd: RMSD
        metadata.count: Segments
        summary.average_segment_length: Avg Seg. Length
        summary.total_length: Total Length
        summary.total_points: Points
        analysis.createdAt: Created At
        
    structure-identification-stats:
        modifiers:
            - common-neighbor-analysis
            - diamond-identifier
            - polyhedral-template-matching
            - dislocation-analysis
        aggregators:
            displayName: Structure Identification
            count: true
        trajectory: Trajectory
        timestep: Timestep
        analysis.config.identificationMode: Identification Mode
        summary.total_identified: Identified
        summary.total_unidentified: Unidentified
        summary.identification_rate: Identification Rate
        analysis.createdAt: Created At

    atomic-strain:
        modifiers:
            - atomic-strain
        aggregators:
            displayName: Atomic Strain
            count: true
        trajectory: Trajectory
        timestep: Timestep
        analysis.config.atomicStrainCutoff: Cutoff
        summary.average_shear_strain: Avg Shear Strain
        summary.max_shear_strain: Max Shear Strain
        metadata.num_invalid_particles: Invalid Particles
        analysis.createdAt: Created At
        perFrameListing:
            title: Atomic Strain Details
            columns:
                - key: id
                  label: Atom ID
                - key: shear_strain
                  label: Shear Strain
                  format: number
                - key: volumetric_strain
                  label: Volumetric Strain
                  format: number
                - key: D2min
                  label: D2min
                  format: number
                - key: strain_tensor
                  label: Strain Tensor
                - key: deformation_gradient
                  label: Deformation Gradient

modifiers:
    # Dislocation Analysis Modifier
    dislocation-analysis:
        preset:
            structureIdentificationOnly: false
        analysisSelection:
            title:
                - path: config.identificationMode
                - path: createdAt
                - path: config.RMSD
                  visibleWhen:
                    config.identificationMode: PTM
            description:
                - path: config.maxTrialCircuitSize
                - path: config.circuitStretchability
        exposure:
            dislocation-analysis:
                results: dislocations.msgpack
                iterable: data
                displayName: Dislocation Analysis
                icon: PiLineSegmentThin
                canvas: true
                raster:
                    component: BoxResults
                    title: "Dislocation Analysis"
                    metrics:
                        - key: "segment_id"
                          label: "Segment Id #"
                          as_record_title: true
                        - key: "length"
                          label: "Length"
                          format: "decimal"
                          decimals: 2
                          unit: "Ã…"
                        - key: "burgers.magnitude"
                          label: "Magnitude"
                          format: "decimal"
                          decimals: 3
                        - key: "burgers.fractional"
                          label: "Burgers Vector"
                        - key: "num_points"
                          label: "Points"
                          format: "number"
                export:
                    name: DislocationExporter
                    type: glb
                    options:
                        lineWidth: 0.8
                        colorByType: true
                        material:
                            baseColor: [1.0, 0.5, 0.0, 1.0]
                            metallic: 0.0
                            roughness: 0.8
                            emissive: [0.0, 0.0, 0.0]

            structure-identification:
                results: atoms.msgpack
                displayName: Structure Identification
                icon: HiCubeTransparent
                canvas: true
                raster:
                    component: StatisticsResults
                    nameKey: "name"
                    valueKey: "count"
                    percentageKey: "percentage"
                    sortBy: "count"
                    sortOrder: "desc"
                    maxItems: 7
                    showSummary: false
                    colors:
                        FCC: "rgb(102, 255, 102)"
                        HCP: "rgb(255, 102, 102)"
                        BCC: "rgb(102, 102, 255)"
                        CUBIC_DIAMOND: "rgb(19, 160, 254)"
                        CUBIC_DIAMOND_FIRST_NEIGH: "rgb(0, 254, 245)"
                        CUBIC_DIAMOND_SECOND_NEIGH: "rgb(126, 254, 181)"
                        HEX_DIAMOND_FIRST_NEIGH: "rgb(254, 220, 0)"
                        HEX_DIAMOND_SECOND_NEIGH: "rgb(204, 229, 81)"
                        HEX_DIAMOND: "rgb(254, 137, 0)"
                        OTHER: "rgb(242, 242, 242)"
                        DEFAULT: "rgb(128, 128, 128)"
                export:
                    name: AtomisticExporter
                    handler: exportAtomsTypeToGLBMinIO
                    type: glb

            defect-mesh:
                results: defect_mesh.msgpack
                icon: SiTraefikmesh
                displayName: Defect Mesh
                canvas: true
                export:
                    name: MeshExporter
                    type: glb
                    options:
                        smoothIterations: 8
                        generateNormals: true
                        enableDoubleSided: true
                        material:
                            baseColor: [1.0, 1.0, 1.0, 1.0]
                            metallic: 0.0
                            roughness: 0.0
                            emissive: [0.0, 0.0, 0.0]

            interface-mesh:
                results: interface_mesh.msgpack
                icon: PiTriangleDashedThin
                displayName: Interface Mesh
                canvas: true
                export:
                    name: MeshExporter
                    type: glb
                    options:
                        smoothIterations: 8
                        generateNormals: true
                        enableDoubleSided: true
                        material:
                            baseColor: [1.0, 1.0, 1.0, 1.0]
                            metallic: 0.0
                            roughness: 0.0
                            emissive: [0.0, 0.0, 0.0]

            simulation-cell:
                results: simulation_cell.msgpack

            structure-identification-stats:
                results: structure_stats.msgpack
            
    # Common Neighbor Analysis Modifier
    common-neighbor-analysis:
        preset:
            identificationMode: CNA
            structureIdentificationOnly: true
        analysisSelection:
            title:
                - path: config.identificationMode
                - path: createdAt
            description:
                - path: config.crystalStructure
                - path: config.structureIdentificationOnly
        exposure:
            common-neighbor-analysis:
                results: atoms.msgpack
                displayName: Common Neighbor Analysis (CNA)
                icon: PiCirclesThreeLight
                canvas: true
                raster: true
                export:
                    name: AtomisticExporter
                    handler: exportAtomsTypeToGLBMinIO
                    type: glb

            structure-identification-stats:
                results: structure_stats.msgpack
                
    # Polyhedral Template Matching Modifier
    polyhedral-template-matching:
        preset:
            identificationMode: PTM
            structureIdentificationOnly: true
        analysisSelection:
            title:
                - path: config.identificationMode
                - path: createdAt
                - path: config.RMSD
            description:
                - path: config.maxTrialCircuitSize
                - path: config.circuitStretchability
                - path: config.RMSD
        exposure:
            polyhedral-template-matching:
                results: atoms.msgpack
                displayName: Polyhedral Template Matching (PTM)
                icon: HiCubeTransparent
                canvas: true
                raster: true
                export:
                    name: AtomisticExporter
                    handler: exportAtomsTypeToGLBMinIO
                    type: glb

            structure-identification-stats:
                results: structure_stats.msgpack

    # Coordination Analysis Modifier
    coordination-analysis:
        preset:
            structureIdentificationOnly: false
        analysisSelection:
            title:
                - path: config.cordinationCutoff
                - path: config.coordinationBins
                - path: createdAt
            description:
                - path: config.coordinationAnalysis
        exposure:
            coordination-analysis:
                results: rdf.msgpack
                displayName: Coordination Analysis
                icon: PiGraph
                canvas: true
                export:
                    name: ChartExporter
                    type: line-chart
                    options:
                        title: Radial Distribution Function
                        xAxis:
                            label: Pair separation distance
                            key: distance
                        yAxis:
                            label: g(r)
                            key: g_r
                        fill: true
                        color: "#ff7f0e"

    # Diamond Identifier Modifier
    diamond-identifier:
        preset:
            identificationMode: DIAMOND
            structureIdentificationOnly: true
        analysisSelection:
            title:
                - path: config.identificationMode
                - path: createdAt
            description:
                - path: config.crystalStructure
                - path: config.structureIdentificationOnly
        exposure:
            diamond-identifier:
                results: atoms.msgpack
                displayName: Diamond Identifier
                icon: RiVipDiamondLine
                canvas: true
                raster: true
                export:
                    name: AtomisticExporter
                    handler: exportAtomsTypeToGLBMinIO
                    type: glb

    # Atomic Strain Modifier
    atomic-strain:
        singleFrameAnalysis: true
        preset:
            coordinationAnalysis: false
            structureIdentificationOnly: false
            atomicStrainEnabled: true
        analysisSelection:
            title:
                - path: config.atomicStrainCutoff
                - path: createdAt
            description:
                - path: config.atomicStrainCalcStrainTensors
                - path: config.atomicStrainCalcDeformationGradient
                - path: config.atomicStrainCalcD2min
        exposure:
            atomic-strain:
                results: atomic_strain.msgpack
                perAtomProperties:
                    - shear_strain
                    - volumetric_strain
                    - strain_tensor
                    - deformation_gradient
                iterable: atomic_strain
                displayName: Atomic Strain Analysis
                icon: PiAtomLight
                canvas: false
                raster: false

entrypoint:
    bin: opendxa
    arguments:
        crystalStructure: 
            type: select
            default: BCC
            label: Crystal Structure
            values:
                FCC: FCC (Face-Centered Cubic)
                BCC: BCC (Body-Centered Cubic)
                HCP: HCP (Hexagonal Closed-Packed)
                CUBIC_DIAMOND: Cubic Diamond
                HEX_DIAMOND: Hexagonal Diamond
                SC: Simple Cubic
            visibleWhen:
                modifier:
                    - dislocation-analysis
                    - common-neighbor-analysis
                    - diamond-identifier

        identificationMode:
            type: select
            default: PTM
            label: Identification Mode
            values:
                PTM: Polyhedral Template Matching (PTM)
                CNA: Common Neighbor Analysis (CNA)
                DIAMOND: Diamond Identifier
            visibleWhen:
                modifier: dislocation-analysis

        maxTrialCircuitSize:
            type: number
            label: Max Trial Circuit Size
            default: 14
            min: 6
            max: 32
            step: 0.5
            visibleWhen:
                modifier: dislocation-analysis

        circuitStretchability:
            type: number
            label: Circuit Stretchability
            default: 9.0
            min: 1
            max: 32
            step: 0.5
            visibleWhen:
                modifier: dislocation-analysis

        rmsd:
            type: number
            label: RMSD
            default: 0.10
            min: 0
            max: 5
            step: 0.01
            visibleWhen:
                identificationMode: PTM
                modifier: polyhedral-template-matching

        defectSmoothingLevel:
            type: number
            label: Defect Smoothing Level
            default: 8
            min: 0
            max: 32
            step: 1
            visibleWhen:
                modifier: dislocation-analysis

        lineSmoothingLevel:
            type: number
            label: Line Smoothing Level
            default: 5
            min: 0
            max: 32
            step: 0.5
            visibleWhen:
                modifier: dislocation-analysis

        linePointInterval:
            type: number
            label: Line Point Interval
            default: 2.5
            min: 0.1
            max: 10
            step: 0.1
            visibleWhen:
                modifier: dislocation-analysis

        onlyPerfectDislocations:
            type: boolean
            label: Only Perfect Dislocations
            default: false
            visibleWhen:
                modifier: dislocation-analysis

        markCoreAtoms:
            type: boolean
            label: Mark Core Atoms
            default: false
            visibleWhen:
                modifier: dislocation-analysis

        structureIdentificationOnly:
            type: boolean
            default: false

        coordinationAnalysis:
            type: boolean
            default: true

        cordinationCutoff:
            type: number
            label: Cutoff Radius
            default: 3.2
            min: 1.0
            max: 20.0
            step: 0.1
            visibleWhen:
                modifier: coordination-analysis

        coordinationBins:
            type: number
            label: Number of Bins
            default: 200
            min: 10
            max: 1000
            step: 1
            visibleWhen:
                modifier: coordination-analysis

        atomicStrainEnabled:
            type: boolean
            default: true

        atomicStrainCutoff:
            type: number
            label: Cutoff Radius
            default: 3.0
            min: 1.0
            max: 20.0
            step: 0.1
            visibleWhen:
                modifier: atomic-strain

        atomicStrainEliminateCellDeformation:
            type: boolean
            label: Eliminate Cell Deformation
            default: false
            visibleWhen:
                modifier: atomic-strain

        atomicStrainAssumeUnwrapped:
            type: boolean
            label: Assume Unwrapped Coordinates
            default: false
            visibleWhen:
                modifier: atomic-strain

        atomicStrainCalcDeformationGradient:
            type: boolean
            label: Calculate Deformation Gradient
            default: true
            visibleWhen:
                modifier: atomic-strain

        referenceSource:
            type: trajectory-frame
            default: 0
            label: Reference Frame
            visibleWhen:
                modifier: atomic-strain

        atomicStrainCalcStrainTensors:
            type: boolean
            label: Calculate Strain Tensors
            default: true
            visibleWhen:
                modifier: atomic-strain

        atomicStrainCalcD2min:
            type: boolean
            label: Calculate D2min (Nonaffine Squared Displacement)
            default: true
            visibleWhen:
                modifier: atomic-strain